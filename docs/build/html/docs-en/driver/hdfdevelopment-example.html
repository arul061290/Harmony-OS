
<!DOCTYPE html>

<html lang="y">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HDF Development Example &#8212; Harmony 1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="hdf-development-example">
<h1>HDF Development Example<a class="headerlink" href="#hdf-development-example" title="Permalink to this headline">¶</a></h1>
<p>The following example shows how to add configurations, implement the
driver code, and compile the code for interaction between the user-level
applications and the driver.</p>
<div class="section" id="adding-configurations">
<h2>Adding Configurations<a class="headerlink" href="#adding-configurations" title="Permalink to this headline">¶</a></h2>
<p>Add the driver configurations to the HDF configuration file (for
example,
<strong>vendor/hisi/hi35xx/hi3516dv300/config/device_info/device_info.hcs</strong>).
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span> <span class="p">{</span>
    <span class="n">device_info</span> <span class="p">{</span>
        <span class="n">match_attr</span> <span class="o">=</span> <span class="s2">&quot;hdf_manager&quot;</span><span class="p">;</span>
        <span class="n">template</span> <span class="n">host</span> <span class="p">{</span>
            <span class="n">hostName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
            <span class="n">template</span> <span class="n">device</span> <span class="p">{</span>
                <span class="n">template</span> <span class="n">deviceNode</span> <span class="p">{</span>
                    <span class="n">policy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="n">priority</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
                    <span class="n">preload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                    <span class="n">permission</span> <span class="o">=</span> <span class="mi">0664</span><span class="p">;</span>
                    <span class="n">moduleName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                    <span class="n">serviceName</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                    <span class="n">deviceMatchAttr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">sample_host</span> <span class="p">::</span> <span class="n">host</span> <span class="p">{</span>
            <span class="n">hostName</span> <span class="o">=</span> <span class="s2">&quot;sample_host&quot;</span><span class="p">;</span>
            <span class="n">sample_device</span> <span class="p">::</span> <span class="n">device</span> <span class="p">{</span>
                <span class="n">device0</span> <span class="p">::</span> <span class="n">deviceNode</span> <span class="p">{</span>
                    <span class="n">policy</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
                    <span class="n">priority</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
                    <span class="n">preload</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="n">permission</span> <span class="o">=</span> <span class="mi">0664</span><span class="p">;</span>
                    <span class="n">moduleName</span> <span class="o">=</span> <span class="s2">&quot;sample_driver&quot;</span><span class="p">;</span>
                    <span class="n">serviceName</span> <span class="o">=</span> <span class="s2">&quot;sample_service&quot;</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="compiling-the-driver-code">
<h2>Compiling the Driver Code<a class="headerlink" href="#compiling-the-driver-code" title="Permalink to this headline">¶</a></h2>
<p>A sample of driver code compiled based on the HDF is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#include &lt;fcntl.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &quot;hdf_log.h&quot;
#include &quot;hdf_base.h&quot;
#include &quot;hdf_device_desc.h&quot;

#define HDF_LOG_TAG sample_driver

#define SAMPLE_WRITE_READ 123

int32_t HdfSampleDriverDispatch(
    struct HdfDeviceObject *deviceObject, int id, struct HdfSBuf *data, struct HdfSBuf *reply)
{
    HDF_LOGE(&quot;%s: received cmd %d&quot;, __func__, id);
    if (id == SAMPLE_WRITE_READ) {
        const char *readData = HdfSbufReadString(data);
        if (readData != NULL) {
            HDF_LOGE(&quot;%s: read data is: %s&quot;, __func__, readData);
        }
        if (!HdfSbufWriteInt32(reply, INT32_MAX)) {
            HDF_LOGE(&quot;%s: reply int32 fail&quot;, __func__);
        }
        return HdfDeviceSendEvent(deviceObject, id, data);
    }
    return HDF_FAILURE;
}

void HdfSampleDriverRelease(struct HdfDeviceObject *deviceObject)
{
    // release resources here
    return;
}

int HdfSampleDriverBind(struct HdfDeviceObject *deviceObject)
{
    if (deviceObject == NULL) {
        return HDF_FAILURE;
    }
    static struct IDeviceIoService testService = {
        .Dispatch = HdfSampleDriverDispatch,
    };
    deviceObject-&gt;service = &amp;testService;
    return HDF_SUCCESS;
}

int HdfSampleDriverInit(struct HdfDeviceObject *deviceObject)
{
    if (deviceObject == NULL) {
        HDF_LOGE(&quot;%s::ptr is null!&quot;, __func__);
        return HDF_FAILURE;
    }
    HDF_LOGE(&quot;Sample driver Init success&quot;);
    return HDF_SUCCESS;
}

struct HdfDriverEntry g_sampleDriverEntry = {
    .moduleVersion = 1,
    .moduleName = &quot;sample_driver&quot;,
    .Bind = HdfSampleDriverBind,
    .Init = HdfSampleDriverInit,
    .Release = HdfSampleDriverRelease,
};

HDF_INIT(g_sampleDriverEntry);
</pre></div>
</div>
</div>
<div class="section" id="compiling-the-code-for-interaction">
<h2>Compiling the Code for Interaction<a class="headerlink" href="#compiling-the-code-for-interaction" title="Permalink to this headline">¶</a></h2>
<p>A sample code for interaction between the user-level application and
driver compiled based on the HDF is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#include &lt;fcntl.h&gt;
#include &lt;sys/stat.h&gt;
#include &lt;sys/ioctl.h&gt;
#include &lt;unistd.h&gt;
#include &quot;hdf_log.h&quot;
#include &quot;hdf_sbuf.h&quot;
#include &quot;hdf_io_service_if.h&quot;

#define HDF_LOG_TAG &quot;sample_test&quot;
#define SAMPLE_SERVICE_NAME &quot;sample_service&quot;

#define SAMPLE_WRITE_READ 123

int g_replyFlag = 0;

static int OnDevEventReceived(void *priv,  uint32_t id, struct HdfSBuf *data)
{
    const char *string = HdfSbufReadString(data);
    if (string == NULL) {
        HDF_LOGE(&quot;fail to read string in event data&quot;);
        g_replyFlag = 1;
        return HDF_FAILURE;
    }
    HDF_LOGE(&quot;%s: dev event received: %u %s&quot;,  (char *)priv, id, string);
    g_replyFlag = 1;
    return HDF_SUCCESS;
}

static int SendEvent(struct HdfIoService *serv, char *eventData)
{
    int ret = 0;
    struct HdfSBuf *data = HdfSBufObtainDefaultSize();
    if (data == NULL) {
        HDF_LOGE(&quot;fail to obtain sbuf data&quot;);
        return 1;
    }

    struct HdfSBuf *reply = HdfSBufObtainDefaultSize();
    if (reply == NULL) {
        HDF_LOGE(&quot;fail to obtain sbuf reply&quot;);
        ret = HDF_DEV_ERR_NO_MEMORY;
        goto out;
    }

    if (!HdfSbufWriteString(data, eventData)) {
        HDF_LOGE(&quot;fail to write sbuf&quot;);
        ret = HDF_FAILURE;
        goto out;
    }

    ret = serv-&gt;dispatcher-&gt;Dispatch(&amp;serv-&gt;object, SAMPLE_WRITE_READ, data, reply);
    if (ret != HDF_SUCCESS) {
        HDF_LOGE(&quot;fail to send service call&quot;);
        goto out;
    }

    int replyData = 0;
    if (!HdfSbufReadInt32(reply, &amp;replyData)) {
        HDF_LOGE(&quot;fail to get service call reply&quot;);
        ret = HDF_ERR_INVALID_OBJECT;
        goto out;
    }
    HDF_LOGE(&quot;Get reply is: %d&quot;, replyData);
out:
    HdfSBufRecycle(data);
    HdfSBufRecycle(reply);
    return ret;
}

int main()
{
    char *sendData = &quot;default event info&quot;;
    struct HdfIoService *serv = HdfIoServiceBind(SAMPLE_SERVICE_NAME, 0);
    if (serv == NULL) {
        HDF_LOGE(&quot;fail to get service %s&quot;, SAMPLE_SERVICE_NAME);
        return HDF_FAILURE;
    }

    static struct HdfDevEventlistener listener = {
        .callBack = OnDevEventReceived,
        .priv =&quot;Service0&quot;
    };

    if (HdfDeviceRegisterEventListener(serv, &amp;listener) != HDF_SUCCESS) {
        HDF_LOGE(&quot;fail to register event listener&quot;);
        return HDF_FAILURE;
    }
    if (SendEvent(serv, sendData)) {
        HDF_LOGE(&quot;fail to send event&quot;);
        return HDF_FAILURE;
    }

    /* wait for event receive event finishing */
    while (g_replyFlag == 0) {
        sleep(1);
    }

    if (HdfDeviceUnregisterEventListener(serv, &amp;listener)) {
        HDF_LOGE(&quot;fail to  unregister listener&quot;);
        return HDF_FAILURE;
    }

    HdfIoServiceRecycle(serv);
    return HDF_SUCCESS;
}
</pre></div>
</div>
<blockquote>
<div><p><img alt="image1" src="../../_images/icon-note2.gif" /> <strong>NOTE:</strong> The code compilation of user-level applications
depends on the dynamic libraries <strong>hdf_core</strong> and <strong>osal</strong> provided
by the HDF because user-level applications use the message sending
interface of the HDF. In the GN compilation file, add the following
dependency relationships: deps = [
“//drivers/hdf/lite/manager:hdf_core”,
“//drivers/hdf/lite/adapter/osal/posix:hdf_posix_osal”, ]</p>
</div></blockquote>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Harmony</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Arul.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/docs-en/driver/hdfdevelopment-example.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>