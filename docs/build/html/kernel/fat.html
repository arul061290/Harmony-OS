
<!DOCTYPE html>

<html lang="y">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FAT &#8212; Harmony 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="fat">
<h1>FAT<a class="headerlink" href="#fat" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>There are FAT12, FAT16, and FAT32. A FAT file system divides a hard disk
into five areas: MBR, DBR, FAT, DIR, and DATA.</p>
<p>FAT supports multiple media, especially removable storage media (such as
USB flash drives, SD cards, and portable hard disks). In this way,
embedded devices can be better compatible with desktop systems such as
Windows and Linux, facilitating file management and operation.</p>
<p>FAT in the OpenHarmony kernel features low code, less resource
occupation, tailorability, and multiple physical media support. It is
compatible with systems such as Windows and Linux, and provides
functions such as identification of multiple devices and partitions.</p>
<p>The OpenHarmony kernel supports multiple partitions on the hard disk. A
FAT file system can be created on the primary or logical partition. The
OpenHarmony kernel can also identify other types of file systems on the
hard disk.</p>
</div>
<div class="section" id="important-notes">
<h2>Important Notes<a class="headerlink" href="#important-notes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>A maximum of 512 FATFS files or folders that can be opened
simultaneously.</p></li>
<li><p>After a file is opened in writable mode, the file cannot be opened
again before it is closed. To open a file for multiple times, the
read-only attribute can be used only. If a file is opened for a long
time and is not closed, data loss will occur. The file can be saved
only after being closed.</p></li>
<li><p>The size of an individual FAT file cannot be greater than 4 GB.</p></li>
<li><p>When there are two SD card slots, the first card inserted is card 0,
and that inserted later is card 1.</p></li>
<li><p>When multi-partition is enabled and there are multiple partitions,
the device node <strong>/dev/mmcblk0</strong> (primary device) registered by card
0 and <strong>/dev/mmcblk0p0</strong> (secondary device) are the same device. In
this case, you cannot perform operations on the primary device.</p></li>
<li><p>The read and write pointers are not separated. Therefore, after a
file is opened in <strong>O_APPEND</strong> mode, the read pointer is also at the
end of the file. You must manually set the position of the read
pointer before reading the file.</p></li>
<li><p>The file modification time is obtained by the <strong>stat</strong> and <strong>lstat</strong>
functions. The creation time and last access time cannot be obtained.
As limited by the FAT protocol, the time before 1980 is not
supported.</p></li>
<li><p>When you use <strong>open</strong> with the parameter <strong>O_TRUNC</strong> to open a file,
the file content will be cleared.</p></li>
<li><p>You can perform the following operations on FAT files: <strong>open</strong>,
<strong>close</strong>, <strong>read</strong>, <strong>write</strong>, <strong>seek</strong>, <strong>sync</strong>, <strong>opendir</strong>,
<strong>closedir</strong>, <strong>readdir</strong>, <strong>rewinddir</strong>, <strong>readdir_r</strong>, <strong>statfs</strong>,
<strong>remove</strong>, <strong>unlink</strong>, <strong>mkdir</strong>, <strong>rmdir</strong>, <strong>rename</strong>, <strong>stat</strong>,
<strong>stat64</strong>, <strong>seek64</strong>, <strong>fallocate</strong>, <strong>fallocate64</strong>, <strong>truncate</strong>,
<strong>truncate64</strong>, <strong>mount</strong>, and <strong>umount</strong>.</p></li>
<li><p>To prevent SD card exceptions and memory leakage, opened files and
directories must be closed and mounted nodes must be unmounted before
an SD card is removed.</p></li>
<li><p>If a FAT file system has been mounted before the <strong>format</strong>
operation, ensure that all directories and files are closed.
Otherwise, the <strong>format</strong> operation will fail.</p></li>
<li><p>FAT supports mounting with the read-only attribute.</p>
<ul>
<li><p>When <strong>MS_RDONLY</strong> is carried in the <strong>mount</strong> function, the
read-only attribute is enabled for the FAT file system. All APIs
with the write attribute, such as <strong>write</strong>, <strong>mkdir</strong>, and
<strong>unlink</strong>, and files that are opened not by using the attribute
<strong>O_RDONLY</strong> are rejected and the error code <strong>EACCESS</strong> is
thrown.</p></li>
<li><p>When <strong>MS_NOSYNC</strong> is carried in the <strong>mount</strong> function, FAT does
not proactively write the content in the cache back to the storage
device. The FAT-related APIs <strong>open</strong>, <strong>close</strong>, <strong>unlink</strong>,
<strong>rename</strong>, <strong>mkdir</strong>, <strong>rmdir</strong>, and <strong>truncate</strong> do not
automatically perform the <strong>sync</strong> operation, which improves the
operation speed. However, the upper layer must actively invoke the
<strong>sync</strong> operation to synchronize data. Otherwise, data may be
lost after a power outage.</p></li>
</ul>
</li>
<li><p>The FAT file system supports periodical cache flushing. After
<strong>LOSCFG_FS_FAT_CACHE_SYNC_THREAD</strong> is enabled in <strong>menuconfig</strong>, the
OpenHarmony kernel creates a task to flush the cache. By default, the
OpenHarmony kernel checks the percentage of dirty data blocks in the
cache every 5 seconds. If the percentage exceeds 80%, the OpenHarmony
kernel performs the <strong>sync</strong> operation to write all dirty data in the
cache back to the disk. The task priority, flush interval, and dirty
data block percentage thresholds can be set by calling
<strong>LOS_SetSyncThreadPrio</strong>, <strong>LOS_SetSyncThreadInterval</strong>, and
<strong>LOS_SetDirtyRatioThreshold</strong>, respectively.</p></li>
<li><p>The default cache size is 16 blocks, and each block has 256 sectors.</p></li>
</ul>
</div>
<div class="section" id="development-guidelines">
<h2>Development Guidelines<a class="headerlink" href="#development-guidelines" title="Permalink to this headline">¶</a></h2>
<p><strong>Device Identification</strong></p>
<ul class="simple">
<li><p>Multi-partition is enabled if <strong>FF_MULTI_PARTITION</strong> in the
<strong>ffconf.h</strong> file is set to <strong>1</strong>.</p></li>
<li><p>Multi-device is enabled if <strong>FF_VOLUMES</strong> in the <strong>ffconf.h</strong> file is
greater than 2.</p></li>
</ul>
<p>When multi-device and multi-partition are enabled, the system
automatically identifies an inserted SD card and registers the device
node. <strong>mmcblk0</strong> (card 0) and <strong>mmcblk1</strong> (card 1) are independent
primary devices. <strong>mmcblk0p0</strong> and <strong>mmcblk0p1</strong> are two partitions of
card 0 and can be used as partitions. Do not use the primary device if a
partition exists.</p>
<p>You can run the <strong>partinfo</strong> command to view information about
identified partitions.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OHOS</span> <span class="c1"># partinfo /dev/mmcblk0p0</span>
<span class="n">part</span> <span class="n">info</span> <span class="p">:</span>
<span class="n">disk</span> <span class="nb">id</span>          <span class="p">:</span> <span class="mi">0</span>
<span class="n">part_id</span> <span class="ow">in</span> <span class="n">system</span><span class="p">:</span> <span class="mi">0</span>
<span class="n">part</span> <span class="n">no</span> <span class="ow">in</span> <span class="n">disk</span>  <span class="p">:</span> <span class="mi">0</span>
<span class="n">part</span> <span class="n">no</span> <span class="ow">in</span> <span class="n">mbr</span>   <span class="p">:</span> <span class="mi">1</span>
<span class="n">part</span> <span class="n">filesystem</span>  <span class="p">:</span> <span class="mi">0</span><span class="n">C</span>
<span class="n">part</span> <span class="n">dev</span> <span class="n">name</span>    <span class="p">:</span> <span class="n">mmcblk0p0</span>
<span class="n">part</span> <span class="n">sec</span> <span class="n">start</span>   <span class="p">:</span> <span class="mi">8192</span>
<span class="n">part</span> <span class="n">sec</span> <span class="n">count</span>   <span class="p">:</span> <span class="mi">31108096</span>
</pre></div>
</div>
<p><strong>FAT Mounting</strong></p>
<p>Mount a FAT file system.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OHOS</span> <span class="c1"># mount /dev/mmcblk0p0 /vs/sd vfat</span>
</pre></div>
</div>
<p>If the following information is displayed, the FAT file system is
mounted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OHOS</span> <span class="c1"># mount /dev/mmcblk0p0 /vs/sd vfat</span>
<span class="n">mount</span> <span class="n">ok</span>
</pre></div>
</div>
<p><strong>FAT Unmounting</strong></p>
<p>Unmount the FAT file system.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OHOS</span> <span class="c1"># umount /vs/sd</span>
</pre></div>
</div>
<p>If the following information is displayed, the FAT file system is
unmounted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OHOS</span> <span class="c1"># umount /vs/sd</span>
<span class="n">umount</span> <span class="n">ok</span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Harmony</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Arul.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/kernel/fat.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>