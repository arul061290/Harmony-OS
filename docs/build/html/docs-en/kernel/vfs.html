
<!DOCTYPE html>

<html lang="y">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VFS &#8212; Harmony 1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="vfs">
<h1>VFS<a class="headerlink" href="#vfs" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="basic-concepts">
<h2>Basic Concepts<a class="headerlink" href="#basic-concepts" title="Permalink to this headline">¶</a></h2>
<p>In essence, VFS is not a real file system. It is an abstract layer on
top of a heterogeneous file system and provides you with a unified
Unix-like file operation interface.</p>
<p>Different types of file systems provide different interfaces. If there
are multiple types of file systems in the system, different and
non-standard interfaces are required for accessing these file systems.
The VFS can be introduced as an abstract layer in the system to
harmonize the differences between these heterogeneous file systems. In
this way, the system does not need to care about the storage medium and
file system type at the bottom layer when accessing a file system. The
figure below illustrates the relationship between the VFS and file
systems.</p>
<div class="line-block">
<div class="line"><strong>Figure 1</strong> Relationship between the VFS and file systems</div>
<div class="line"><img alt="image1" src="../../_images/relationship-between-the-vfs-and-file-systems.png" /></div>
</div>
<p>In the OpenHarmony kernel, the VFS framework is implemented using the
tree structure in the memory. Each node in the tree is an <strong>inode</strong>
structure. After a device is registered and a file system is mounted,
the corresponding node is generated in the tree based on the path. VFS
provides the following functions:</p>
<ul class="simple">
<li><p>Node query</p></li>
<li><p>Unified file system invoking (standard)</p></li>
</ul>
</div>
<div class="section" id="working-principles">
<h2>Working Principles<a class="headerlink" href="#working-principles" title="Permalink to this headline">¶</a></h2>
<p>At the VFS layer, standard Unix file operation functions (such as
<strong>open</strong>, <strong>read</strong>, and <strong>write</strong>) can be used to access different file
systems on different media.</p>
<p>There are three types of <strong>inode</strong> tree nodes in the VFS framework
memory:</p>
<ul class="simple">
<li><p>Virtual node: virtual file of the VFS framework, for example,
<strong>/usr</strong> and <strong>/usr/bin</strong>, which ensures the continuity of the tree</p></li>
<li><p>Device node: mapping to a device in the <strong>/dev</strong> directory, for
example, <strong>/dev/mmc0blk0</strong></p></li>
<li><p>Mount point: used to mount a specific file system, for example,
<strong>/vs/sd</strong> or <strong>/mnt</strong></p></li>
</ul>
<p><strong>inode</strong> has two key fields: <strong>u</strong> (pointer to the function structure)
and <strong>i_private</strong> (data pointer).</p>
<div class="line-block">
<div class="line"><strong>Figure 2</strong> Tree structure of the file system</div>
<div class="line"><img alt="image2" src="../../_images/tree-structure-of-the-file-system.png" /></div>
</div>
</div>
<div class="section" id="important-notes">
<h2>Important Notes<a class="headerlink" href="#important-notes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>For all file systems in VFS, the name of a directory or file can
contain a maximum of 255 bytes, and the maximum length of a full path
is 259 bytes. Directories or files whose length exceeds the maximum
length cannot be created.</p></li>
<li><p>Currently, only the JFFS2 file system supports complete permission
control.</p></li>
<li><p>After the <strong>inode_find()</strong> function is called, the number of found
<strong>inode</strong> connections is incremented by 1. After the call is
complete, the <strong>inode_release()</strong> function is called to decrease the
number of <strong>inode</strong> connections by 1. Therefore, the two functions
must be used together.</p></li>
<li><p>Devices are classified into character devices and block devices. To
ensure data security of the file system on a block device, mount the
file system and then operate data through the file system interface.</p></li>
<li><p>The <strong>los_vfs_init()</strong> function can be called only once. Multiple
calls cause exceptions to the file system.</p></li>
<li><p>The file names and directory names in all file systems of the
OpenHarmony kernel can contain only hyphens (-) and underscores (_),
but no other special characters. If other special characters are
used, unpredictable errors may occur.</p></li>
<li><p>The OpenHarmony kernel supports the <strong>open()+O_DIRECTORY</strong> method to
obtain directory data.</p></li>
<li><p>The mount point must be an empty directory. A file system cannot be
mounted to the same mount point or to a directory or file under
another mount point. Otherwise, the device or system may be damaged.</p></li>
<li><p>Only one of the <strong>O_RDWR</strong>, <strong>O_WRONLY</strong>, and <strong>O_RDONLY</strong> parameters
can be used with <strong>open</strong> to open a file. If two or more of them are
used, the file read or write operation is rejected, and the error
code <strong>EACCESS</strong> is returned.</p></li>
<li><p>Before unmounting a file system in the OpenHarmony kernel, ensure
that all directories and files are closed. Otherwise, unmounting
fails. Forcible unmounting may cause problems such as file system and
file damage.</p></li>
<li><p>Before removing an SD card, ensure that all directories and files are
closed and unmounting is performed. Forcible removal may cause
problems such as SD card data loss and SD card damage.</p></li>
</ul>
</div>
<div class="section" id="development-guidelines">
<h2>Development Guidelines<a class="headerlink" href="#development-guidelines" title="Permalink to this headline">¶</a></h2>
<p><strong>How to Develop</strong></p>
<p>It is recommended that driver developers use the VFS framework to
register or uninstall devices and the application layer use <strong>open()</strong>
and <strong>read()</strong> to operate character device files to invoke drivers.</p>
<ol class="arabic simple">
<li><p>After calling <strong>los_vfs_init()</strong>, the system uses the slash (/) as
<strong>root_inode</strong>.</p></li>
<li><p>The system calls <strong>register_driver()</strong> and <strong>register_blockdriver()</strong>
to generate a device node, and calls <strong>mount()</strong> to generate a mount
point.</p></li>
<li><p>The system files the structure information and inserts the node into
a proper position in the tree based on the node name.</p></li>
<li><p>During invoking, the system searches the tree for the corresponding
device node or mount point based on the path.</p></li>
<li><p>The system calls the corresponding function by using the found node
pointer.</p></li>
</ol>
<p><strong>File Descriptor</strong></p>
<p>A process can have a maximum of 256 file descriptors (including file and
socket descriptors). The system can have a maximum of 640 file
descriptors, where there can be a maximum of</p>
<ul class="simple">
<li><p>512 file descriptors</p></li>
<li><p>128 socket descriptors</p></li>
</ul>
<p><strong>Operations Supported by VFS</strong></p>
<p>open, close, read, write, seek, ioctl, fcntl, mmap, sync, dup, dup2,
truncate, opendir, closedir, readdir, readdir, rewinddir, mount, umount,
statfs, unlink, remove, mkdir, rmdir, rename, stat, utime, seek64,
fallocate, fallocate64, truncate64, chmod, and chown</p>
<blockquote>
<div><p><img alt="image3" src="../../_images/icon-note4.gif" /> <strong>NOTE:</strong> - Currently, only the interfaces for modifying the
attributes of JFFS2 files and VFS device nodes are provided. Each
system has its own processing mode for attributes such as read-only.
- In the OpenHarmony kernel, the attributes do not conflict with each
other, and they can be modified randomly. - A read-only file or
directory in the OpenHarmony kernel cannot be deleted. - A read-only
file or directory in the OpenHarmony kernel can be renamed. - A
read-only file cannot be opened in <strong>O_CREAT</strong>, <strong>O_TRUNC</strong>, or other
modes with the write permission. - If the hidden attribute is added
to a system file in the OpenHarmony kernel, the system file can be
found only on the command line interface (CLI) in the Windows OS.
(This system file cannot be viewed regardless of whether <strong>Show
hidden files, folders, and drivers</strong> is selected.)</p>
</div></blockquote>
</div>
<div class="section" id="use-code">
<h2>Use Code<a class="headerlink" href="#use-code" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdio.h&gt;</span>
<span class="c1">#include &lt;stdlib.h&gt;</span>
<span class="c1">#include &lt;dirent.h&gt;</span>
<span class="c1">#include &lt;errno.h&gt;</span>
<span class="c1">#include &lt;sys/stat.h&gt;</span>
<span class="c1">#include &lt;sys/types.h&gt;</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="nb">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="n">char</span> <span class="o">*</span><span class="n">dirname</span> <span class="o">=</span> <span class="s2">&quot;/test&quot;</span><span class="p">;</span>
    <span class="n">char</span> <span class="o">*</span><span class="n">pathname0</span> <span class="o">=</span> <span class="s2">&quot;/test/test0&quot;</span><span class="p">;</span>
    <span class="n">char</span> <span class="o">*</span><span class="n">pathname1</span> <span class="o">=</span> <span class="s2">&quot;/test/test1&quot;</span><span class="p">;</span>
    <span class="n">char</span> <span class="o">*</span><span class="n">pathname2</span> <span class="o">=</span> <span class="s2">&quot;/test/test2&quot;</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">dirent</span> <span class="o">**</span><span class="n">namelist</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">num</span><span class="p">;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">mkdir</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="mi">0777</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">EEXIST</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">goto</span> <span class="n">EXIT</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">mkdir</span><span class="p">(</span><span class="n">pathname0</span><span class="p">,</span> <span class="mi">0777</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">EEXIST</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">goto</span> <span class="n">EXIT0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">mkdir</span><span class="p">(</span><span class="n">pathname1</span><span class="p">,</span> <span class="mi">0777</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">EEXIST</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">goto</span> <span class="n">EXIT1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">mkdir</span><span class="p">(</span><span class="n">pathname2</span><span class="p">,</span> <span class="mi">0777</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">EEXIST</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">goto</span> <span class="n">EXIT2</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">num</span> <span class="o">=</span> <span class="n">scandir</span><span class="p">(</span><span class="n">dirname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">namelist</span><span class="p">,</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">alphasort</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s2">&quot;scandir&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">num</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">namelist</span><span class="p">[</span><span class="n">num</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">d_name</span><span class="p">);</span>
            <span class="n">free</span><span class="p">(</span><span class="n">namelist</span><span class="p">[</span><span class="n">num</span><span class="p">]);</span>
        <span class="p">}</span>
        <span class="n">free</span><span class="p">(</span><span class="n">namelist</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;fs_demo exit.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">EXIT2</span><span class="p">:</span>
    <span class="n">remove</span><span class="p">(</span><span class="n">pathname2</span><span class="p">);</span>
<span class="n">EXIT1</span><span class="p">:</span>
    <span class="n">remove</span><span class="p">(</span><span class="n">pathname1</span><span class="p">);</span>
<span class="n">EXIT0</span><span class="p">:</span>
    <span class="n">remove</span><span class="p">(</span><span class="n">pathname0</span><span class="p">);</span>
<span class="n">EXIT</span><span class="p">:</span>
    <span class="n">remove</span><span class="p">(</span><span class="n">dirname</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="result-verification">
<h2>Result Verification<a class="headerlink" href="#result-verification" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OHOS</span> <span class="c1"># test2</span>
<span class="n">test1</span>
<span class="n">test0</span>
<span class="n">fs_demo</span> <span class="n">exit</span><span class="o">.</span>
</pre></div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Harmony</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Arul.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/docs-en/kernel/vfs.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>