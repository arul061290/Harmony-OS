
<!DOCTYPE html>

<html lang="y">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Developing the First Driver Running on Hi3516 &#8212; Harmony 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="developing-the-first-driver-running-on-hi3516">
<h1>Developing the First Driver Running on Hi3516<a class="headerlink" href="#developing-the-first-driver-running-on-hi3516" title="Permalink to this headline">¶</a></h1>
<p>This section describes how to develop a driver on the board, including
introduction, compilation, burning, and running of the driver.</p>
<div class="section" id="acquiring-source-code">
<h2>Acquiring Source Code<a class="headerlink" href="#acquiring-source-code" title="Permalink to this headline">¶</a></h2>
<p>Acquire the source code by referring to <a class="reference external" href="developing-the-first-example-program-running-on-hi3516.md#section215953714245">Acquiring Source
Code</a>.</p>
</div>
<div class="section" id="introduction-to-driver">
<h2>Introduction to Driver<a class="headerlink" href="#introduction-to-driver" title="Permalink to this headline">¶</a></h2>
<p>The following operations take a HDF-based UART driver as an example to
show how to add configuration files, code the driver, and compile the
code for interactions between the user-space applications and the
driver. The driver source code is stored in the
<strong>vendor/huawei/hdf/sample</strong> directory.</p>
<ol class="arabic">
<li><p>Add Configurations.</p>
<p>Add driver configurations to the HDF driver configuration file (for
example,
<strong>vendor/hisi/hi35xx/hi3516dv300/config/uart/uart_config.hcs</strong>).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span> <span class="p">{</span>
    <span class="n">platform</span> <span class="p">{</span>
        <span class="n">uart_sample</span> <span class="p">{</span>
            <span class="n">num</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>            <span class="o">//</span> <span class="n">UART</span> <span class="n">device</span> <span class="n">number</span>
            <span class="n">base</span> <span class="o">=</span> <span class="mh">0x120a0000</span><span class="p">;</span>  <span class="o">//</span> <span class="n">Base</span> <span class="n">address</span> <span class="n">of</span> <span class="n">the</span> <span class="n">UART</span> <span class="n">register</span>
            <span class="n">irqNum</span> <span class="o">=</span> <span class="mi">38</span><span class="p">;</span>
            <span class="n">baudrate</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>
            <span class="n">uartClk</span> <span class="o">=</span> <span class="mi">24000000</span><span class="p">;</span>
            <span class="n">wlen</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
            <span class="n">parity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">stopBit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">match_attr</span> <span class="o">=</span> <span class="s2">&quot;sample_uart_5&quot;</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Add the device node information to the HDF device configuration file
(for example,
<strong>vendor/hisi/hi35xx/hi3516dv300/config/device_info/device_info.hcs</strong>)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span> <span class="p">{</span>
    <span class="n">device_info</span> <span class="p">{</span>
        <span class="n">platform</span> <span class="p">::</span> <span class="n">host</span> <span class="p">{</span>
            <span class="n">hostName</span> <span class="o">=</span> <span class="s2">&quot;platform_host&quot;</span><span class="p">;</span>
            <span class="n">priority</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
            <span class="n">device_uart</span> <span class="p">::</span> <span class="n">device</span> <span class="p">{</span>
                <span class="n">device5</span> <span class="p">::</span> <span class="n">deviceNode</span> <span class="p">{</span>
                    <span class="n">policy</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
                    <span class="n">priority</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
                    <span class="n">permission</span> <span class="o">=</span> <span class="mi">0660</span><span class="p">;</span>
                    <span class="n">moduleName</span> <span class="o">=</span> <span class="s2">&quot;UART_SAMPLE&quot;</span><span class="p">;</span>
                    <span class="n">serviceName</span> <span class="o">=</span> <span class="s2">&quot;HDF_PLATFORM_UART_5&quot;</span><span class="p">;</span>
                    <span class="n">deviceMatchAttr</span> <span class="o">=</span> <span class="s2">&quot;sample_uart_5&quot;</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<blockquote>
<div><p><img alt="image1" src="../_images/icon-note5.gif" /> <strong>NOTE:</strong> The configuration files are in the same path as
the source code of the UART driver. You need to manually add the
files to the path of the Hi3516DV300 board.</p>
</div></blockquote>
</li>
<li><p>Register a UART driver entry.</p>
<p>Register the <strong>HdfDriverEntry</strong> of the UART driver with the HDF.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">Bind</span> <span class="n">the</span> <span class="n">UART</span> <span class="n">driver</span> <span class="n">interface</span> <span class="n">to</span> <span class="n">the</span> <span class="n">HDF</span><span class="o">.</span>
<span class="n">static</span> <span class="n">int32_t</span> <span class="n">SampleUartDriverBind</span><span class="p">(</span><span class="n">struct</span> <span class="n">HdfDeviceObject</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">struct</span> <span class="n">UartHost</span> <span class="o">*</span><span class="n">uartHost</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">HDF_ERR_INVALID_OBJECT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">HDF_LOGI</span><span class="p">(</span><span class="s2">&quot;Enter </span><span class="si">%s</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>

    <span class="n">uartHost</span> <span class="o">=</span> <span class="n">UartHostCreate</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uartHost</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: UartHostCreate failed&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">uartHost</span><span class="o">-&gt;</span><span class="n">service</span><span class="o">.</span><span class="n">Dispatch</span> <span class="o">=</span> <span class="n">SampleDispatch</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">HDF_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Obtain</span> <span class="n">configuration</span> <span class="n">information</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">HCS</span> <span class="n">of</span> <span class="n">the</span> <span class="n">UART</span> <span class="n">driver</span><span class="o">.</span>
<span class="n">static</span> <span class="n">uint32_t</span> <span class="n">GetUartDeviceResource</span><span class="p">(</span>
    <span class="n">struct</span> <span class="n">UartDevice</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span> <span class="n">const</span> <span class="n">struct</span> <span class="n">DeviceResourceNode</span> <span class="o">*</span><span class="n">resourceNode</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">struct</span> <span class="n">UartResource</span> <span class="o">*</span><span class="n">resource</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">DeviceResourceIface</span> <span class="o">*</span><span class="n">dri</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
    <span class="n">dri</span> <span class="o">=</span> <span class="n">DeviceResourceGetIfaceInstance</span><span class="p">(</span><span class="n">HDF_CONFIG_SOURCE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dri</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="n">dri</span><span class="o">-&gt;</span><span class="n">GetUint32</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;DeviceResourceIface is invalid&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dri</span><span class="o">-&gt;</span><span class="n">GetUint32</span><span class="p">(</span><span class="n">resourceNode</span><span class="p">,</span> <span class="s2">&quot;num&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HDF_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;uart config read num fail&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dri</span><span class="o">-&gt;</span><span class="n">GetUint32</span><span class="p">(</span><span class="n">resourceNode</span><span class="p">,</span> <span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HDF_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;uart config read base fail&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">resource</span><span class="o">-&gt;</span><span class="n">physBase</span> <span class="o">=</span> <span class="p">(</span><span class="n">unsigned</span> <span class="n">long</span><span class="p">)</span><span class="n">OsalIoRemap</span><span class="p">(</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">physBase</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;uart config fail to remap physBase&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dri</span><span class="o">-&gt;</span><span class="n">GetUint32</span><span class="p">(</span><span class="n">resourceNode</span><span class="p">,</span> <span class="s2">&quot;irqNum&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">irqNum</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HDF_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;uart config read irqNum fail&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dri</span><span class="o">-&gt;</span><span class="n">GetUint32</span><span class="p">(</span><span class="n">resourceNode</span><span class="p">,</span> <span class="s2">&quot;baudrate&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">baudrate</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HDF_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;uart config read baudrate fail&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dri</span><span class="o">-&gt;</span><span class="n">GetUint32</span><span class="p">(</span><span class="n">resourceNode</span><span class="p">,</span> <span class="s2">&quot;wlen&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">wlen</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HDF_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;uart config read wlen fail&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dri</span><span class="o">-&gt;</span><span class="n">GetUint32</span><span class="p">(</span><span class="n">resourceNode</span><span class="p">,</span> <span class="s2">&quot;parity&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HDF_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;uart config read parity fail&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dri</span><span class="o">-&gt;</span><span class="n">GetUint32</span><span class="p">(</span><span class="n">resourceNode</span><span class="p">,</span> <span class="s2">&quot;stopBit&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">stopBit</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HDF_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;uart config read stopBit fail&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dri</span><span class="o">-&gt;</span><span class="n">GetUint32</span><span class="p">(</span><span class="n">resourceNode</span><span class="p">,</span> <span class="s2">&quot;uartClk&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">uartClk</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HDF_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;uart config read uartClk fail&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">HDF_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Attach</span> <span class="n">the</span> <span class="n">configuration</span> <span class="ow">and</span> <span class="n">interface</span> <span class="n">of</span> <span class="n">the</span> <span class="n">UART</span> <span class="n">driver</span> <span class="n">to</span> <span class="n">the</span> <span class="n">HDF</span><span class="o">.</span>
<span class="n">static</span> <span class="n">int32_t</span> <span class="n">AttachUartDevice</span><span class="p">(</span><span class="n">struct</span> <span class="n">UartHost</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">struct</span> <span class="n">HdfDeviceObject</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">int32_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">UartDevice</span> <span class="o">*</span><span class="n">uartDevice</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="nb">property</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: property is NULL&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">uartDevice</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span> <span class="n">UartDevice</span> <span class="o">*</span><span class="p">)</span><span class="n">OsalMemCalloc</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="n">struct</span> <span class="n">UartDevice</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">uartDevice</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: OsalMemCalloc uartDevice error&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_ERR_MALLOC_FAIL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">GetUartDeviceResource</span><span class="p">(</span><span class="n">uartDevice</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="nb">property</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">HDF_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">OsalMemFree</span><span class="p">(</span><span class="n">uartDevice</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">host</span><span class="o">-&gt;</span><span class="n">num</span> <span class="o">=</span> <span class="n">uartDevice</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">.</span><span class="n">num</span><span class="p">;</span>
    <span class="n">host</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">uartDevice</span><span class="p">;</span>
    <span class="n">AddUartDevice</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">InitUartDevice</span><span class="p">(</span><span class="n">uartDevice</span><span class="p">);</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Initialize</span> <span class="n">the</span> <span class="n">UART</span> <span class="n">driver</span><span class="o">.</span>
<span class="n">static</span> <span class="n">int32_t</span> <span class="n">SampleUartDriverInit</span><span class="p">(</span><span class="n">struct</span> <span class="n">HdfDeviceObject</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">int32_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">UartHost</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: device is NULL&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_ERR_INVALID_OBJECT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">HDF_LOGI</span><span class="p">(</span><span class="s2">&quot;Enter </span><span class="si">%s</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">UartHostFromDevice</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: host is NULL&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">AttachUartDevice</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">HDF_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: attach error&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_FAILURE</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">host</span><span class="o">-&gt;</span><span class="n">method</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">g_sampleUartHostMethod</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">static</span> <span class="n">void</span> <span class="n">DeinitUartDevice</span><span class="p">(</span><span class="n">struct</span> <span class="n">UartDevice</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">struct</span> <span class="n">UartRegisterMap</span> <span class="o">*</span><span class="n">regMap</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span> <span class="n">UartRegisterMap</span> <span class="o">*</span><span class="p">)</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">.</span><span class="n">physBase</span><span class="p">;</span>
    <span class="o">/*</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">the</span> <span class="n">UART</span> <span class="n">to</span> <span class="n">enter</span> <span class="n">the</span> <span class="n">idle</span> <span class="n">state</span><span class="o">.</span> <span class="o">*/</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">UartPl011IsBusy</span><span class="p">(</span><span class="n">regMap</span><span class="p">));</span>
    <span class="n">UartPl011ResetRegisters</span><span class="p">(</span><span class="n">regMap</span><span class="p">);</span>
    <span class="n">uart_clk_cfg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">false</span><span class="p">);</span>
    <span class="n">OsalIoUnmap</span><span class="p">((</span><span class="n">void</span> <span class="o">*</span><span class="p">)</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">.</span><span class="n">physBase</span><span class="p">);</span>
    <span class="n">device</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">UART_DEVICE_UNINITIALIZED</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Detach</span> <span class="ow">and</span> <span class="n">release</span> <span class="n">the</span> <span class="n">UART</span> <span class="n">driver</span><span class="o">.</span>
<span class="n">static</span> <span class="n">void</span> <span class="n">DetachUartDevice</span><span class="p">(</span><span class="n">struct</span> <span class="n">UartHost</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">struct</span> <span class="n">UartDevice</span> <span class="o">*</span><span class="n">uartDevice</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: invalid parameter&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">uartDevice</span> <span class="o">=</span> <span class="n">host</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
    <span class="n">DeinitUartDevice</span><span class="p">(</span><span class="n">uartDevice</span><span class="p">);</span>
    <span class="p">(</span><span class="n">void</span><span class="p">)</span><span class="n">OsalMemFree</span><span class="p">(</span><span class="n">uartDevice</span><span class="p">);</span>
    <span class="n">host</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Release</span> <span class="n">the</span> <span class="n">UART</span> <span class="n">driver</span><span class="o">.</span>
<span class="n">static</span> <span class="n">void</span> <span class="n">SampleUartDriverRelease</span><span class="p">(</span><span class="n">struct</span> <span class="n">HdfDeviceObject</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">struct</span> <span class="n">UartHost</span> <span class="o">*</span><span class="n">host</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
    <span class="n">HDF_LOGI</span><span class="p">(</span><span class="s2">&quot;Enter </span><span class="si">%s</span><span class="s2">:&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: device is NULL&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">host</span> <span class="o">=</span> <span class="n">UartHostFromDevice</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: host is NULL&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">!=</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">DetachUartDevice</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">UartHostDestroy</span><span class="p">(</span><span class="n">host</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">struct</span> <span class="n">HdfDriverEntry</span> <span class="n">g_sampleUartDriverEntry</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">.</span><span class="n">moduleVersion</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">.</span><span class="n">moduleName</span> <span class="o">=</span> <span class="s2">&quot;UART_SAMPLE&quot;</span><span class="p">,</span>
    <span class="o">.</span><span class="n">Bind</span> <span class="o">=</span> <span class="n">SampleUartDriverBind</span><span class="p">,</span>
    <span class="o">.</span><span class="n">Init</span> <span class="o">=</span> <span class="n">SampleUartDriverInit</span><span class="p">,</span>
    <span class="o">.</span><span class="n">Release</span> <span class="o">=</span> <span class="n">SampleUartDriverRelease</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">HDF_INIT</span><span class="p">(</span><span class="n">g_sampleUartDriverEntry</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Register a UART driver interface.</p>
<p>Implement the UART driver interface using the template
<strong>UartHostMethod</strong> provided by the HDF.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="n">int32_t</span> <span class="n">SampleUartHostInit</span><span class="p">(</span><span class="n">struct</span> <span class="n">UartHost</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HDF_LOGI</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Enter&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: invalid parameter&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_ERR_INVALID_PARAM</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">HDF_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">static</span> <span class="n">int32_t</span> <span class="n">SampleUartHostDeinit</span><span class="p">(</span><span class="n">struct</span> <span class="n">UartHost</span> <span class="o">*</span><span class="n">host</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HDF_LOGI</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Enter&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: invalid parameter&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_ERR_INVALID_PARAM</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">HDF_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Write</span> <span class="n">data</span> <span class="n">into</span> <span class="n">the</span> <span class="n">UART</span> <span class="n">device</span><span class="o">.</span>
<span class="n">static</span> <span class="n">int32_t</span> <span class="n">SampleUartHostWrite</span><span class="p">(</span><span class="n">struct</span> <span class="n">UartHost</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">uint8_t</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">uint32_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HDF_LOGI</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Enter&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
    <span class="n">uint32_t</span> <span class="n">idx</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">UartRegisterMap</span> <span class="o">*</span><span class="n">regMap</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">UartDevice</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="n">data</span> <span class="o">==</span> <span class="n">NULL</span> <span class="o">||</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: invalid parameter&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_ERR_INVALID_PARAM</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">device</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span> <span class="n">UartDevice</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: device is NULL&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_ERR_INVALID_PARAM</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">regMap</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span> <span class="n">UartRegisterMap</span> <span class="o">*</span><span class="p">)</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">.</span><span class="n">physBase</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">UartPl011Write</span><span class="p">(</span><span class="n">regMap</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">HDF_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">baud</span> <span class="n">rate</span> <span class="n">of</span> <span class="n">the</span> <span class="n">UART</span> <span class="n">device</span><span class="o">.</span>
<span class="n">static</span> <span class="n">int32_t</span> <span class="n">SampleUartHostSetBaud</span><span class="p">(</span><span class="n">struct</span> <span class="n">UartHost</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">uint32_t</span> <span class="n">baudRate</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HDF_LOGI</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Enter&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
    <span class="n">struct</span> <span class="n">UartDevice</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">UartRegisterMap</span> <span class="o">*</span><span class="n">regMap</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
    <span class="n">UartPl011Error</span> <span class="n">err</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: invalid parameter&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_ERR_INVALID_PARAM</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">device</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span> <span class="n">UartDevice</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: device is NULL&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_ERR_INVALID_PARAM</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">regMap</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span> <span class="n">UartRegisterMap</span> <span class="o">*</span><span class="p">)</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">resource</span><span class="o">.</span><span class="n">physBase</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">UART_DEVICE_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">UART_PL011_ERR_NOT_INIT</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">baudRate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">UART_PL011_ERR_INVALID_BAUD</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">UartPl011SetBaudrate</span><span class="p">(</span><span class="n">regMap</span><span class="p">,</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">uartClk</span><span class="p">,</span> <span class="n">baudRate</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">UART_PL011_ERR_NONE</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">device</span><span class="o">-&gt;</span><span class="n">baudrate</span> <span class="o">=</span> <span class="n">baudRate</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Obtain</span> <span class="n">the</span> <span class="n">baud</span> <span class="n">rate</span> <span class="n">of</span> <span class="n">the</span> <span class="n">UART</span> <span class="n">device</span><span class="o">.</span>
<span class="n">static</span> <span class="n">int32_t</span> <span class="n">SampleUartHostGetBaud</span><span class="p">(</span><span class="n">struct</span> <span class="n">UartHost</span> <span class="o">*</span><span class="n">host</span><span class="p">,</span> <span class="n">uint32_t</span> <span class="o">*</span><span class="n">baudRate</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">HDF_LOGI</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: Enter&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
    <span class="n">struct</span> <span class="n">UartDevice</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">host</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: invalid parameter&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_ERR_INVALID_PARAM</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">device</span> <span class="o">=</span> <span class="p">(</span><span class="n">struct</span> <span class="n">UartDevice</span> <span class="o">*</span><span class="p">)</span><span class="n">host</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">: device is NULL&quot;</span><span class="p">,</span> <span class="vm">__func__</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">HDF_ERR_INVALID_PARAM</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">*</span><span class="n">baudRate</span> <span class="o">=</span> <span class="n">device</span><span class="o">-&gt;</span><span class="n">baudrate</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">HDF_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="n">Bind</span> <span class="n">the</span> <span class="n">UART</span> <span class="n">device</span> <span class="n">using</span> <span class="n">HdfUartSampleInit</span><span class="o">.</span>
<span class="n">struct</span> <span class="n">UartHostMethod</span> <span class="n">g_sampleUartHostMethod</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">.</span><span class="n">Init</span> <span class="o">=</span> <span class="n">SampleUartHostInit</span><span class="p">,</span>
    <span class="o">.</span><span class="n">Deinit</span> <span class="o">=</span> <span class="n">SampleUartHostDeinit</span><span class="p">,</span>
    <span class="o">.</span><span class="n">Read</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">,</span>
    <span class="o">.</span><span class="n">Write</span> <span class="o">=</span> <span class="n">SampleUartHostWrite</span><span class="p">,</span>
    <span class="o">.</span><span class="n">SetBaud</span> <span class="o">=</span> <span class="n">SampleUartHostSetBaud</span><span class="p">,</span>
    <span class="o">.</span><span class="n">GetBaud</span> <span class="o">=</span> <span class="n">SampleUartHostGetBaud</span><span class="p">,</span>
    <span class="o">.</span><span class="n">SetAttribute</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">,</span>
    <span class="o">.</span><span class="n">GetAttribute</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">,</span>
    <span class="o">.</span><span class="n">SetTransMode</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Add the sample module of the UART driver to the compilation script
<strong>vendor/huawei/hdf/hdf_vendor.mk</strong>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>LITEOS_BASELIB += -lhdf_uart_sample
LIB_SUBDIRS    += $(VENDOR_HDF_DRIVERS_ROOT)/sample/platform/uart
</pre></div>
</div>
</li>
<li><p>Implement the code for interaction between the user-space
applications and driver.</p>
<p>Create the <strong>/dev/uartdev-5</strong> node after the UART driver is
initialized successfully. The following example shows how to interact
with the UART driver through the node.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &lt;stdlib.h&gt;</span>
<span class="c1">#include &lt;unistd.h&gt;</span>
<span class="c1">#include &lt;fcntl.h&gt;</span>
<span class="c1">#include &quot;hdf_log.h&quot;</span>

<span class="c1">#define HDF_LOG_TAG &quot;hello_uart&quot;</span>
<span class="c1">#define INFO_SIZE 16</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nb">int</span> <span class="n">ret</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="n">const</span> <span class="n">char</span> <span class="n">info</span><span class="p">[</span><span class="n">INFO_SIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot; HELLO UART! &quot;</span><span class="p">};</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/dev/uartdev-5&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;hello_uart uartdev-5 open failed </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">INFO_SIZE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;hello_uart write uartdev-5 ret is </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;hello_uart uartdev-5 close failed </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Add the <strong>hello_uart_sample</strong> component to the <strong>hdf</strong> subsystem
directory in the <strong>build/lite/product/ipcamera_hi3516dv300.json</strong>
file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;subsystem&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hdf&quot;</span><span class="p">,</span>
      <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hdf_sample&quot;</span><span class="p">,</span> <span class="s2">&quot;dir&quot;</span><span class="p">:</span> <span class="s2">&quot;//vendor/huawei/hdf/sample/platform/uart:hello_uart_sample&quot;</span><span class="p">,</span> <span class="s2">&quot;features&quot;</span><span class="p">:[]</span> <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<blockquote>
<div><p><img alt="image2" src="../_images/icon-note5.gif" /> <strong>NOTE:</strong> Preceding code snippets are for reference only.
You can view the complete sample code in
<strong>vendor/huawei/hdf/sample.</strong> The sample code is not automatically
compiled by default. You can add it to the compilation script.</p>
</div></blockquote>
</li>
</ol>
</div>
<div class="section" id="compiling-and-burning">
<h2>Compiling and Burning<a class="headerlink" href="#compiling-and-burning" title="Permalink to this headline">¶</a></h2>
<p>Compile and burn images by referring to <a class="reference external" href="developing-the-first-example-program-running-on-hi3516.md#section1077671315253">Compiling
Code</a>
and <a class="reference external" href="developing-the-first-example-program-running-on-hi3516.md#section18061240152520">Burning
Images</a>.</p>
</div>
<div class="section" id="running-an-image">
<h2>Running an Image<a class="headerlink" href="#running-an-image" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Connect to a serial port.</p>
<blockquote>
<div><p><img alt="image3" src="../_images/icon-notice3.gif" /> <strong>NOTICE:</strong> If the sconnection fails, rectify the fault
by referring to problem 5 in the <a class="reference external" href="faqs-0.md">FAQs</a> section.</p>
</div></blockquote>
<p><strong>Figure 1</strong> Serial port connection</p>
<p><img alt="image4" src="../_images/chuankou1.png" /></p>
<ol class="arabic simple">
<li><p>Click <strong>Serial port</strong> to enable it.</p></li>
<li><p>Enter the serial port number “com11” and press <strong>Enter</strong> until
<strong>hisillicon</strong> is displayed.</p></li>
<li><p>Go to step 2 if the board is started for the first time or the
startup parameters need to be modified; go to step 3 otherwise.</p></li>
</ol>
</li>
<li><p>(Mandatory when the board is started for the first time) Modify the
bootcmd and bootargs parameters of U-boot. You need to perform this
step only once if the parameters need not to be modified during the
operation. The board automatically starts after it is reset.</p>
<blockquote>
<div><p><img alt="image5" src="../_images/icon-notice3.gif" /> <strong>NOTICE:</strong> The default waiting time in the U-boot is 2s.
You can press <strong>Enter</strong> to interrupt the waiting and run the
<strong>reset</strong> command to restart the system after “hisillicon” is
displayed.</p>
</div></blockquote>
<p><strong>Table 1</strong> Parameters of the U-boot</p>
<table><thead align="left"><tr id="en-us_topic_0000001052906247_row1423410183818"><th class="cellrowborder" valign="top" width="50%" id="mcps1.2.3.1.1"><p id="en-us_topic_0000001052906247_p623461163818"><p>Command</p>
</p></th><th class="cellrowborder" valign="top" width="50%" id="mcps1.2.3.1.2"><p id="en-us_topic_0000001052906247_p42341014388"><p>Description</p>
</p></th></tr></thead><tbody><tr id="en-us_topic_0000001052906247_row1623471113817"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="en-us_topic_0000001052906247_p102341719385"><p>setenv bootcmd “mmc read 0x0 0x80000000 0x800 0x4800; go 0x80000000”;</p>
</p></td><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="en-us_topic_0000001052906247_p92347120389"><p>Run this command to read content that has a size of 0x4800 (9 MB) and
a start address of 0x800 (1 MB) to the memory address 0x80000000.</p>
</p></td></tr><tr id="en-us_topic_0000001052906247_row12234912381"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="en-us_topic_0000001052906247_p172306219392"><p>setenv bootargs “console=ttyAMA0,115200n8 root=emmc fstype=vfat
rootaddr=10 M rootsize=15 M rw”;</p>
</p></td><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="en-us_topic_0000001052906247_p13489329396"><p>Run this command to set the output mode to serial port output, baud
rate to 115200, data bit to 8, rootfs to be mounted to the emmc
component, and file system type to vfat.</p>
</p><p id="en-us_topic_0000001052906247_p12481832163913"><p>rootaddr=10 M, rootsize=15 M rw indicates the start address and size
of the rootfs.img file to be burnt, respectively. The file size must
be the same as that of the compiled file in the IDE.</p>
</p></td></tr><tr id="en-us_topic_0000001052906247_row18234161153820"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="en-us_topic_0000001052906247_p823417118386"><p>saveenv</p>
</p></td><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="en-us_topic_0000001052906247_p32341616389"><p>saveenv means to save the current configuration.</p>
</p></td></tr><tr id="en-us_topic_0000001052906247_row192345113811"><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.1 "><p id="en-us_topic_0000001052906247_p7235111183819"><p>reset</p>
</p></td><td class="cellrowborder" valign="top" width="50%" headers="mcps1.2.3.1.2 "><p id="en-us_topic_0000001052906247_p123781411114016"><p>reset means to reset the board.</p>
</p></td></tr></tbody></table><blockquote>
<div><p><img alt="image6" src="../_images/icon-notice3.gif" /> <strong>NOTICE:</strong> <strong>go 0x80000000</strong> (optional) indicates that
the command is fixed in the startup parameters by default and the
board automatically starts after it is reset. If you want to
manually start the board, press <strong>Enter</strong> in the countdown phase
of the U-boot startup to interrupt the automatic startup.</p>
</div></blockquote>
</li>
<li><p>Run the <strong>reset</strong> command and press <strong>Enter</strong> to restart the board.
After the board is restarted, <strong>OHOS</strong> is displayed when you press
<strong>Enter</strong>.</p>
<p><strong>Figure 2</strong> System startup</p>
<p><img alt="image7" src="../_images/qi1.png" /></p>
</li>
<li><p>In the root directory, run the <strong>./bin/hello_uart</strong> command line to
execute the demo program. The compilation result is shown in the
following example.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">OHOS</span> <span class="c1"># ./bin/hello_uart</span>
<span class="n">OHOS</span> <span class="c1">#  HELLO UART!</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="follow-up-learning">
<h2>Follow-up Learning<a class="headerlink" href="#follow-up-learning" title="Permalink to this headline">¶</a></h2>
<p>Congratulations! You have finished all steps! You are advised to go on
learning how to develop <a class="reference external" href="../guide/screen-and-camera-control.md">Cameras with a
Screen</a>.</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Harmony</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Arul.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/quick-start/developing-the-first-driver-running-on-hi3516.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>