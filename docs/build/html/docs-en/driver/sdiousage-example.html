
<!DOCTYPE html>

<html lang="y">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SDIO Usage Example &#8212; Harmony 1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="sdio-usage-example">
<h1>SDIO Usage Example<a class="headerlink" href="#sdio-usage-example" title="Permalink to this headline">Â¶</a></h1>
<p>The following example shows how to use an SDIO device. First, open an
SDIO controller whose bus number is 1, exclusively claim a host, enable
the SDIO device, claim an SDIO IRQ, and then perform SDIO communication
(such as reading and writing). After the SDIO communication, release the
SDIO IRQ, disable the SDIO device, release the host, and close the SDIO
controller.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;hdf_log.h&quot;</span>
<span class="c1">#include &quot;sdio_if.h&quot;</span>

<span class="c1">#define TEST_FUNC_NUM 1 /* The I/O function whose ID is 1 is used. */</span>
<span class="c1">#define TEST_FBR_BASE_ADDR 0x100 /* FBR base address of the I/O function whose ID is 1 */</span>
<span class="c1">#define TEST_ADDR_OFFSET 9 /* Address offset of the register to read or write */</span>
<span class="c1">#define TEST_DATA_LEN 3 /* Length of the data to read or write */</span>
<span class="c1">#define TEST_BLOCKSIZE 2 /* Size of a data block, in bytes */</span>

<span class="o">/*</span> <span class="n">Implement</span> <span class="n">the</span> <span class="n">SDIO</span> <span class="n">IRQ</span> <span class="n">function</span> <span class="n">based</span> <span class="n">on</span> <span class="n">the</span> <span class="n">application</span><span class="o">.</span> <span class="o">*/</span>
<span class="n">static</span> <span class="n">void</span> <span class="n">SdioIrqFunc</span><span class="p">(</span><span class="n">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioIrqFunc: data is NULL.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">/*</span> <span class="n">You</span> <span class="n">need</span> <span class="n">to</span> <span class="n">add</span> <span class="n">specific</span> <span class="n">implementations</span><span class="o">.</span> <span class="o">*/</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">SdioTestSample</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">int32_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">DevHandle</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
    <span class="n">uint8_t</span> <span class="n">data</span><span class="p">[</span><span class="n">TEST_DATA_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">int16_t</span> <span class="n">busNum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">uint8_t</span> <span class="n">val</span><span class="p">;</span>
    <span class="n">uint32_t</span> <span class="n">addr</span><span class="p">;</span>

    <span class="o">/*</span> <span class="n">Open</span> <span class="n">an</span> <span class="n">SDIO</span> <span class="n">controller</span> <span class="n">whose</span> <span class="n">bus</span> <span class="n">number</span> <span class="ow">is</span> <span class="mf">1.</span> <span class="o">*/</span>
    <span class="n">handle</span> <span class="o">=</span> <span class="n">SdioOpen</span><span class="p">(</span><span class="n">busNum</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioOpen: failed!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
   <span class="o">/*</span> <span class="n">Claim</span> <span class="n">a</span> <span class="n">host</span> <span class="n">exclusively</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">SdioClaimHost</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
   <span class="o">/*</span> <span class="n">Enable</span> <span class="n">the</span> <span class="n">SDIO</span> <span class="n">device</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SdioEnableFunc</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioEnableFunc: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">ENABLE_ERR</span><span class="p">;</span>
    <span class="p">}</span>
   <span class="o">/*</span> <span class="n">Claim</span> <span class="n">an</span> <span class="n">SDIO</span> <span class="n">IRQ</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SdioClaimIrq</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">SdioIrqFunc</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioClaimIrq: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">CLAIM_IRQ_ERR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">/*</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">block</span> <span class="n">size</span> <span class="n">to</span> <span class="mi">2</span> <span class="nb">bytes</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SdioSetBlockSize</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">TEST_BLOCKSIZE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioSetBlockSize: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">COMM_ERR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">/*</span> <span class="n">Read</span> <span class="mi">3</span><span class="o">-</span><span class="n">byte</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">incremental</span> <span class="n">address</span> <span class="n">of</span> <span class="n">an</span> <span class="n">SDIO</span> <span class="n">device</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">TEST_FBR_BASE_ADDR</span> <span class="o">*</span> <span class="n">TEST_FUNC_NUM</span> <span class="o">+</span> <span class="n">TEST_ADDR_OFFSET</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SdioReadBytes</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">TEST_DATA_LEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioReadBytes: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">COMM_ERR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">/*</span> <span class="n">Write</span> <span class="mi">3</span><span class="o">-</span><span class="n">byte</span> <span class="n">data</span> <span class="n">into</span> <span class="n">the</span> <span class="n">incremental</span> <span class="n">address</span> <span class="n">of</span> <span class="n">an</span> <span class="n">SDIO</span> <span class="n">device</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SdioWriteBytes</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">TEST_DATA_LEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioWriteBytes: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">COMM_ERR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">/*</span> <span class="n">Read</span> <span class="mi">1</span><span class="o">-</span><span class="n">byte</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">SDIO</span> <span class="n">device</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SdioReadBytes</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioReadBytes: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">COMM_ERR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">/*</span> <span class="n">Write</span> <span class="mi">1</span><span class="o">-</span><span class="n">byte</span> <span class="n">data</span> <span class="n">into</span> <span class="n">the</span> <span class="n">SDIO</span> <span class="n">device</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SdioWriteBytes</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioWriteBytes: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">COMM_ERR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">/*</span> <span class="n">Read</span> <span class="mi">3</span><span class="o">-</span><span class="n">byte</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">fixed</span> <span class="n">address</span> <span class="n">of</span> <span class="n">an</span> <span class="n">SDIO</span> <span class="n">device</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SdioReadBytesFromFixedAddr</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">TEST_DATA_LEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioReadBytesFromFixedAddr: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">COMM_ERR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">/*</span> <span class="n">Write</span> <span class="mi">1</span><span class="o">-</span><span class="n">byte</span> <span class="n">data</span> <span class="n">to</span> <span class="n">the</span> <span class="n">fixed</span> <span class="n">address</span> <span class="n">of</span> <span class="n">an</span> <span class="n">SDIO</span> <span class="n">device</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SdioWriteBytesToFixedAddr</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioWriteBytesToFixedAddr: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">COMM_ERR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">/*</span> <span class="n">Read</span> <span class="mi">1</span><span class="o">-</span><span class="n">byte</span> <span class="n">data</span> <span class="kn">from</span> <span class="nn">SDIO</span> <span class="n">function</span> <span class="mf">0.</span> <span class="o">*/</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SdioReadBytesFromFunc0</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioReadBytesFromFunc0: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">COMM_ERR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">/*</span> <span class="n">Write</span> <span class="mi">1</span><span class="o">-</span><span class="n">byte</span> <span class="n">data</span> <span class="n">into</span> <span class="n">SDIO</span> <span class="n">function</span> <span class="mf">0.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SdioWriteBytesToFunc0</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioWriteBytesToFunc0: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">COMM_ERR</span><span class="p">;</span>
    <span class="p">}</span>
<span class="n">COMM_ERR</span><span class="p">:</span>
    <span class="o">/*</span> <span class="n">Release</span> <span class="n">the</span> <span class="n">SDIO</span> <span class="n">IRQ</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SdioReleaseIrq</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioReleaseIrq: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
    <span class="p">}</span>
<span class="n">CLAIM_IRQ_ERR</span><span class="p">:</span>
    <span class="o">/*</span> <span class="n">Disable</span> <span class="n">the</span> <span class="n">SDIO</span> <span class="n">device</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SdioDisableFunc</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SdioDisableFunc: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
    <span class="p">}</span>
<span class="n">ENABLE_ERR</span><span class="p">:</span>
    <span class="o">/*</span> <span class="n">Release</span> <span class="n">the</span> <span class="n">exclusively</span> <span class="n">claimed</span> <span class="n">host</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">SdioReleaseHost</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
    <span class="o">/*</span> <span class="n">Close</span> <span class="n">an</span> <span class="n">SDIO</span> <span class="n">controller</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">SdioClose</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Harmony</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Arul.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/docs-en/driver/sdiousage-example.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>