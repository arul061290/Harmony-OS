
<!DOCTYPE html>

<html lang="y">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SPI Usage Example &#8212; Harmony 1.0 documentation</title>
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="spi-usage-example">
<h1>SPI Usage Example<a class="headerlink" href="#spi-usage-example" title="Permalink to this headline">Â¶</a></h1>
<p>The following is a usage example of an SPI device, including how to
obtain an SPI device handle, set the configuration parameters, and then
read or write data from or into the SPI device, and finally destroy the
SPI device handle.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#include &quot;hdf_log.h&quot;</span>
<span class="c1">#include &quot;spi_if.h&quot;</span>

<span class="n">void</span> <span class="n">SpiTestSample</span><span class="p">(</span><span class="n">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">int32_t</span> <span class="n">ret</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">SpiCfg</span> <span class="n">cfg</span><span class="p">;</span>                  <span class="o">/*</span> <span class="n">SPI</span> <span class="n">device</span> <span class="n">configuration</span> <span class="n">information</span> <span class="o">*/</span>
    <span class="n">struct</span> <span class="n">SpiDevInfo</span> <span class="n">spiDevinfo</span><span class="p">;</span>       <span class="o">/*</span> <span class="n">SPI</span> <span class="n">device</span> <span class="n">descriptor</span> <span class="o">*/</span>
    <span class="n">struct</span> <span class="n">DevHandle</span> <span class="o">*</span><span class="n">spiHandle</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span> <span class="o">/*</span> <span class="n">SPI</span> <span class="n">device</span> <span class="n">handle</span> <span class="o">*/</span>
    <span class="n">struct</span> <span class="n">SpiMsg</span> <span class="n">msg</span><span class="p">;</span>                  <span class="o">/*</span> <span class="n">Custom</span> <span class="n">message</span> <span class="n">to</span> <span class="n">be</span> <span class="n">transferred</span> <span class="o">*/</span>
    <span class="n">uint8_t</span> <span class="n">rbuff</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
    <span class="n">uint8_t</span> <span class="n">wbuff</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0x78</span> <span class="p">};</span>
    <span class="n">uint8_t</span> <span class="n">wbuff2</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0xb2</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0xd4</span> <span class="p">};</span>

    <span class="n">spiDevinfo</span><span class="o">.</span><span class="n">busNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>              <span class="o">/*</span> <span class="n">SPI</span> <span class="n">device</span> <span class="n">bus</span> <span class="n">number</span> <span class="o">*/</span>
    <span class="n">spiDevinfo</span><span class="o">.</span><span class="n">csNum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>               <span class="o">/*</span> <span class="n">SPI</span> <span class="n">device</span> <span class="n">CS</span> <span class="n">number</span> <span class="o">*/</span>
    <span class="n">spiHandle</span> <span class="o">=</span> <span class="n">SpiOpen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spiDevinfo</span><span class="p">);</span>   <span class="o">/*</span> <span class="n">Obtain</span> <span class="n">an</span> <span class="n">SPI</span> <span class="n">device</span> <span class="n">handle</span> <span class="n">based</span> <span class="n">on</span> <span class="n">spiDevinfo</span><span class="o">.</span> <span class="o">*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">spiHandle</span> <span class="o">==</span> <span class="n">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SpiOpen: failed</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">/*</span> <span class="n">Obtain</span> <span class="n">configuration</span> <span class="n">parameters</span> <span class="n">of</span> <span class="n">an</span> <span class="n">SPI</span> <span class="n">device</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SpiGetCfg</span><span class="p">(</span><span class="n">spiHandle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SpiGetCfg: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">err</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">maxSpeedHz</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span>                <span class="o">/*</span> <span class="n">Change</span> <span class="n">the</span> <span class="n">maximum</span> <span class="n">clock</span> <span class="n">frequency</span> <span class="n">to</span> <span class="mf">115200.</span> <span class="o">*/</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">bitsPerWord</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>                    <span class="o">/*</span> <span class="n">Change</span> <span class="n">the</span> <span class="n">word</span> <span class="n">width</span> <span class="n">to</span> <span class="mi">8</span> <span class="n">bits</span><span class="o">.</span> <span class="o">*/</span>
    <span class="o">/*</span> <span class="n">Set</span> <span class="n">configuration</span> <span class="n">parameters</span> <span class="k">for</span> <span class="n">an</span> <span class="n">SPI</span> <span class="n">device</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SpiSetCfg</span><span class="p">(</span><span class="n">spiHandle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SpiSetCfg: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">err</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">/*</span> <span class="n">Write</span> <span class="n">specified</span> <span class="n">length</span> <span class="n">of</span> <span class="n">data</span> <span class="n">into</span> <span class="n">an</span> <span class="n">SPI</span> <span class="n">device</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SpiWrite</span><span class="p">(</span><span class="n">spiHandle</span><span class="p">,</span> <span class="n">wbuff</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SpiWrite: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">err</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">/*</span> <span class="n">Read</span> <span class="n">data</span> <span class="n">of</span> <span class="n">a</span> <span class="n">specified</span> <span class="n">length</span> <span class="kn">from</span> <span class="nn">an</span> <span class="n">SPI</span> <span class="n">device</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SpiRead</span><span class="p">(</span><span class="n">spiHandle</span><span class="p">,</span> <span class="n">rbuff</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SpiRead: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">err</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">wbuf</span> <span class="o">=</span> <span class="n">wbuff2</span><span class="p">;</span>  <span class="o">/*</span> <span class="n">Pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">data</span> <span class="n">to</span> <span class="n">write</span> <span class="o">*/</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">rbuf</span> <span class="o">=</span> <span class="n">rbuff</span><span class="p">;</span>   <span class="o">/*</span> <span class="n">Pointer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">data</span> <span class="n">to</span> <span class="n">read</span> <span class="o">*/</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>        <span class="o">/*</span> <span class="n">The</span> <span class="n">length</span> <span class="n">of</span> <span class="n">the</span> <span class="n">data</span> <span class="n">to</span> <span class="n">be</span> <span class="n">read</span> <span class="ow">or</span> <span class="n">written</span> <span class="ow">is</span> <span class="mi">4</span> <span class="n">bits</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">csChange</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>   <span class="o">/*</span> <span class="n">Disable</span> <span class="n">the</span> <span class="n">CS</span> <span class="n">before</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">transfer</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">delayUs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>    <span class="o">/*</span> <span class="n">No</span> <span class="n">delay</span> <span class="n">before</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">transfer</span> <span class="o">*/</span>
    <span class="n">msg</span><span class="o">.</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">115200</span><span class="p">;</span> <span class="o">/*</span> <span class="n">Speed</span> <span class="n">of</span> <span class="n">this</span> <span class="n">transfer</span> <span class="o">*/</span>
    <span class="o">/*</span> <span class="n">Launch</span> <span class="n">a</span> <span class="n">custom</span> <span class="n">transfer</span><span class="o">.</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">messages</span> <span class="n">to</span> <span class="n">be</span> <span class="n">transferred</span> <span class="ow">is</span> <span class="mf">1.</span> <span class="o">*/</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">SpiTransfer</span><span class="p">(</span><span class="n">spiHandle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">HDF_LOGE</span><span class="p">(</span><span class="s2">&quot;SpiTransfer: failed, ret </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="n">goto</span> <span class="n">err</span><span class="p">;</span>
    <span class="p">}</span>
<span class="n">err</span><span class="p">:</span>
    <span class="o">/*</span> <span class="n">Destroy</span> <span class="n">the</span> <span class="n">SPI</span> <span class="n">device</span> <span class="n">handle</span><span class="o">.</span> <span class="o">*/</span>
    <span class="n">SpiClose</span><span class="p">(</span><span class="n">spiHandle</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Harmony</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Arul.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.3.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../../_sources/docs-en/driver/spiusage-example.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>